<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LakshmiFX WhatsApp Inbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #0b1017;
      color: #f5f5f5;
      height: 100vh;
      overflow: hidden;
    }

    .app-shell {
      display: flex;
      height: 100vh;
    }

    /* LEFT: CONTACTS */
    .sidebar {
      width: 280px;
      border-right: 1px solid #1d2535;
      background: #060a10;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #1d2535;
      font-weight: 600;
      font-size: 16px;
    }

    .sidebar-subtitle {
      padding: 0 16px 12px;
      font-size: 12px;
      color: #9aa4b8;
    }

    .contacts-list {
      flex: 1;
      overflow-y: auto;
    }

    .contact-item {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid #141b27;
    }

    .contact-item:hover {
      background: #151c28;
    }

    .contact-item.active {
      background: #1c2434;
    }

    .contact-number {
      font-size: 14px;
      margin-bottom: 4px;
    }

    .contact-last {
      font-size: 11px;
      color: #9aa4b8;
    }

    /* RIGHT: MAIN */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .top-tabs {
      display: flex;
      border-bottom: 1px solid #1d2535;
      background: #060a10;
    }

    .tab-btn {
      padding: 12px 18px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #97a3ba;
      border-bottom: 2px solid transparent;
    }

    .tab-btn.active {
      color: #ffffff;
      border-bottom-color: #2ecc71;
      font-weight: 600;
    }

    .tab-btn:hover {
      background: #111827;
    }

    .tab-panels {
      flex: 1;
      position: relative;
    }

    .tab-panel {
      position: absolute;
      inset: 0;
      padding: 16px;
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* CHAT PANEL */
    .chat-header {
      margin-bottom: 8px;
      font-size: 14px;
      color: #9aa4b8;
    }

    .chat-window {
      border-radius: 8px;
      background: #020617;
      border: 1px solid #111827;
      height: calc(100% - 52px);
      display: flex;
      flex-direction: column;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
    }

    .message-row {
      margin-bottom: 10px;
      max-width: 70%;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.4;
      word-break: break-word;
    }

    .msg-in {
      background: #111827;
      align-self: flex-start;
    }

    .msg-out {
      background: #16a34a;
      align-self: flex-end;
    }

    .msg-meta {
      font-size: 10px;
      margin-top: 4px;
      opacity: 0.7;
    }

    .chat-input {
      display: flex;
      border-top: 1px solid #111827;
    }

    .chat-input textarea {
      flex: 1;
      resize: none;
      border: none;
      padding: 10px;
      font-size: 13px;
      background: transparent;
      color: #e5e7eb;
      outline: none;
    }

    .chat-input button {
      border: none;
      padding: 0 18px;
      background: #16a34a;
      color: #ffffff;
      font-weight: 600;
      cursor: pointer;
    }

    .chat-input button:hover {
      background: #22c55e;
    }

    /* TEMPLATES PANEL */

    .templates-layout {
      display: flex;
      height: 100%;
      gap: 16px;
    }

    .templates-list,
    .templates-form {
      flex: 1;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #111827;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .panel-subtitle {
      font-size: 11px;
      color: #9aa4b8;
      margin-bottom: 12px;
    }

    .template-item {
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 6px;
      background: #020617;
      border: 1px solid #111827;
      cursor: pointer;
    }

    .template-item.active {
      border-color: #22c55e;
      background: #0b1120;
    }

    .template-name {
      font-size: 13px;
      margin-bottom: 4px;
    }

    .template-body-preview {
      font-size: 11px;
      color: #9aa4b8;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .field {
      margin-bottom: 8px;
    }

    .field label {
      display: block;
      font-size: 12px;
      margin-bottom: 3px;
      color: #d1d5db;
    }

    .field input,
    .field textarea,
    .field select {
      width: 100%;
      padding: 7px 8px;
      border-radius: 6px;
      border: 1px solid #111827;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      outline: none;
    }

    .field textarea {
      resize: vertical;
      min-height: 70px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 12px;
      border-radius: 6px;
      border: none;
      font-size: 12px;
      cursor: pointer;
    }

    .btn-primary {
      background: #16a34a;
      color: #fff;
      font-weight: 600;
    }

    .btn-primary:hover {
      background: #22c55e;
    }

    .btn-outline {
      border: 1px solid #334155;
      color: #e5e7eb;
      background: transparent;
    }

    .btn-outline:hover {
      background: #111827;
    }

    .btn-row {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }

    /* BROADCAST PANEL */

    .broadcast-layout {
      display: flex;
      height: 100%;
      gap: 16px;
    }

    .broadcast-col {
      flex: 1;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #111827;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
    }

    .numbers-input {
      flex: 1;
      resize: none;
      padding: 7px 8px;
      border-radius: 6px;
      border: 1px solid #111827;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      outline: none;
    }

    .muted {
      font-size: 11px;
      color: #9aa4b8;
    }

    .file-name {
      font-size: 11px;
      color: #9aa4b8;
      margin-top: 4px;
      word-break: break-all;
    }

    .status-bar {
      position: fixed;
      bottom: 10px;
      right: 16px;
      padding: 6px 10px;
      font-size: 11px;
      border-radius: 6px;
      background: #020617;
      border: 1px solid #111827;
      color: #e5e7eb;
      opacity: 0.9;
    }

    .status-bar.error {
      border-color: #f87171;
      color: #fecaca;
    }

    .status-bar.ok {
      border-color: #22c55e;
      color: #bbf7d0;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- LEFT: CONTACTS -->
    <aside class="sidebar">
      <div class="sidebar-header">Contacts</div>
      <div class="sidebar-subtitle">
        No contacts yet. Send a WhatsApp message to your number to start.
      </div>
      <div id="contacts" class="contacts-list"></div>
    </aside>

    <!-- RIGHT: MAIN -->
    <main class="main">
      <div class="top-tabs">
        <button class="tab-btn active" data-tab="inbox">Inbox</button>
        <button class="tab-btn" data-tab="templates">Templates</button>
        <button class="tab-btn" data-tab="broadcast">Broadcast</button>
      </div>

      <div class="tab-panels">
        <!-- INBOX TAB -->
        <section id="tab-inbox" class="tab-panel active">
          <div class="chat-header" id="chatHeader">
            Select a contact from the left panel.
          </div>
          <div class="chat-window">
            <div id="messages" class="messages"></div>
            <div class="chat-input">
              <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
              <button id="sendBtn">Send</button>
            </div>
          </div>
        </section>

        <!-- TEMPLATES TAB -->
        <section id="tab-templates" class="tab-panel">
          <div class="templates-layout">
            <div class="templates-list">
              <div class="panel-title">Saved templates</div>
              <div class="panel-subtitle">
                Click a template to preview or use it in Broadcast.
              </div>
              <div id="templatesList"></div>
            </div>

            <div class="templates-form">
              <div class="panel-title">Create / edit template</div>
              <div class="panel-subtitle">
                Use placeholders like <code>{{name}}</code> which you can merge when broadcasting.
              </div>

              <div class="field">
                <label for="tplName">Template name</label>
                <input id="tplName" type="text" placeholder="Example: Welcome_Message" />
              </div>

              <div class="field">
                <label for="tplCategory">Category</label>
                <select id="tplCategory">
                  <option value="utility">Utility</option>
                  <option value="marketing">Marketing</option>
                  <option value="authentication">Authentication</option>
                </select>
              </div>

              <div class="field">
                <label for="tplBody">Message body</label>
                <textarea id="tplBody" placeholder="Hi {{name}}, welcome to LakshmiFX ..."></textarea>
              </div>

              <div class="btn-row">
                <button class="btn btn-primary" id="saveTemplateBtn">Save template</button>
                <button class="btn btn-outline" id="resetTemplateBtn">Reset</button>
              </div>
            </div>
          </div>
        </section>

        <!-- BROADCAST TAB -->
        <section id="tab-broadcast" class="tab-panel">
          <div class="broadcast-layout">
            <!-- LEFT: SETTINGS -->
            <div class="broadcast-col">
              <div class="panel-title">Broadcast settings</div>
              <div class="panel-subtitle">
                Choose a template and send to numbers manually or via Excel upload.
              </div>

              <div class="field">
                <label for="broadcastTemplate">Template</label>
                <select id="broadcastTemplate">
                  <option value="">-- Select a template --</option>
                </select>
              </div>

              <div class="field">
                <label>Preview</label>
                <textarea id="broadcastPreview" readonly style="min-height: 80px;"></textarea>
              </div>

              <p class="muted">
                Placeholders (e.g. <code>{{name}}</code>) are not auto-merged in this simple UI.
                You can still design them and process them later on the backend if needed.
              </p>
            </div>

            <!-- MIDDLE: MANUAL NUMBERS -->
            <div class="broadcast-col">
              <div class="panel-title">Manual numbers</div>
              <div class="panel-subtitle">
                One WhatsApp number per line. Use full country code (e.g. 919490140810).
              </div>

              <textarea
                id="manualNumbers"
                class="numbers-input"
                placeholder="919490140810&#10;91950xxxxxx&#10;..."
              ></textarea>

              <div class="btn-row">
                <button class="btn btn-primary" id="sendManualBtn">Send broadcast (manual)</button>
              </div>
            </div>

            <!-- RIGHT: EXCEL UPLOAD -->
            <div class="broadcast-col">
              <div class="panel-title">Excel upload</div>
              <div class="panel-subtitle">
                Upload an .xlsx or .csv file with a column named <strong>phone</strong>.
              </div>

              <div class="field">
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" />
                <div id="fileName" class="file-name"></div>
              </div>

              <p class="muted">
                The file is sent to the server. Backend parses it and uses your chosen template.
              </p>

              <div class="btn-row">
                <button class="btn btn-primary" id="sendFileBtn">Send broadcast (file)</button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <div id="statusBar" class="status-bar" style="display:none;"></div>

  <script>
    let currentContact = null;
    let templates = [];

    // -------------------- UTILITIES -------------------- //
    function showStatus(msg, type = "ok") {
      const el = document.getElementById("statusBar");
      el.textContent = msg;
      el.className = "status-bar " + type;
      el.style.display = "block";
      clearTimeout(el._timeout);
      el._timeout = setTimeout(() => {
        el.style.display = "none";
      }, 4000);
    }

    async function apiGet(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error("GET " + url + " failed");
      return res.json();
    }

    async function apiPostJson(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      if (!res.ok) throw new Error("POST " + url + " failed");
      return res.json().catch(() => ({}));
    }

    // -------------------- TABS -------------------- //
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabPanels = {
      inbox: document.getElementById("tab-inbox"),
      templates: document.getElementById("tab-templates"),
      broadcast: document.getElementById("tab-broadcast")
    };

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        Object.entries(tabPanels).forEach(([id, panel]) => {
          panel.classList.toggle("active", id === tab);
        });
      });
    });

    // -------------------- CONTACTS / CHAT -------------------- //
    async function loadContacts() {
      try {
        const contacts = await apiGet("/api/contacts");
        const container = document.getElementById("contacts");
        container.innerHTML = "";

        if (!contacts.length) {
          return;
        }

        contacts.forEach(c => {
          const div = document.createElement("div");
          div.className = "contact-item";
          div.dataset.number = c.waNumber;

          const num = document.createElement("div");
          num.className = "contact-number";
          num.textContent = c.waNumber;

          const last = document.createElement("div");
          last.className = "contact-last";
          last.textContent = c.lastMessageAt
            ? "Last: " + new Date(c.lastMessageAt).toLocaleString()
            : "";

          div.appendChild(num);
          div.appendChild(last);

          div.addEventListener("click", () => {
            document
              .querySelectorAll(".contact-item")
              .forEach(el => el.classList.remove("active"));
            div.classList.add("active");
            selectContact(c.waNumber);
          });

          container.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        showStatus("Failed to load contacts", "error");
      }
    }

    async function selectContact(waNumber) {
      currentContact = waNumber;
      document.getElementById("chatHeader").textContent =
        "Chat − " + waNumber;
      await loadMessages();
    }

    async function loadMessages() {
      if (!currentContact) return;
      try {
        const msgs = await apiGet("/api/messages?waNumber=" + encodeURIComponent(currentContact));
        const container = document.getElementById("messages");
        container.innerHTML = "";

        msgs.forEach(m => {
          const row = document.createElement("div");
          row.className = "message-row " + (m.direction === "out" ? "msg-out" : "msg-in");

          const text = document.createElement("div");
          text.textContent = m.text || "";

          const meta = document.createElement("div");
          meta.className = "msg-meta";
          const ts = m.timestamp
            ? new Date(parseInt(m.timestamp) * 1000).toLocaleString()
            : "";
          meta.textContent = (m.direction === "out" ? "You • " : "Client • ") + ts;

          row.appendChild(text);
          row.appendChild(meta);
          container.appendChild(row);
        });

        container.scrollTop = container.scrollHeight;
      } catch (err) {
        console.error(err);
        showStatus("Failed to load messages", "error");
      }
    }

    async function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!currentContact) {
        alert("Select a contact first.");
        return;
      }
      if (!text) return;

      try {
        await apiPostJson("/api/send", {
          waNumber: currentContact,
          text
        });
        input.value = "";
        await loadMessages();
      } catch (err) {
        console.error(err);
        alert("Send failed – check server logs.");
      }
    }

    document.getElementById("sendBtn").addEventListener("click", sendMessage);
    document
      .getElementById("messageInput")
      .addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

    // -------------------- TEMPLATES -------------------- //
    async function loadTemplates() {
      try {
        templates = await apiGet("/api/templates");
      } catch (err) {
        console.error(err);
        templates = [];
      }
      renderTemplatesList();
      populateBroadcastTemplateSelect();
    }

    function renderTemplatesList() {
      const listEl = document.getElementById("templatesList");
      listEl.innerHTML = "";

      if (!templates.length) {
        listEl.innerHTML =
          '<div class="muted">No templates yet. Create one on the right.</div>';
        return;
      }

      templates.forEach(tpl => {
        const div = document.createElement("div");
        div.className = "template-item";
        div.dataset.id = tpl.id || tpl._id || tpl.name;

        const name = document.createElement("div");
        name.className = "template-name";
        name.textContent = tpl.name;

        const preview = document.createElement("div");
        preview.className = "template-body-preview";
        preview.textContent = tpl.body || "";

        div.appendChild(name);
        div.appendChild(preview);

        div.addEventListener("click", () => {
          document
            .querySelectorAll(".template-item")
            .forEach(el => el.classList.remove("active"));
          div.classList.add("active");

          // Load selected into form
          document.getElementById("tplName").value = tpl.name || "";
          document.getElementById("tplBody").value = tpl.body || "";
          document.getElementById("tplCategory").value =
            tpl.category || "utility";

          // Also update broadcast tab preview
          const sel = document.getElementById("broadcastTemplate");
          sel.value = tpl.id || tpl._id || tpl.name;
          updateBroadcastPreview();
        });

        listEl.appendChild(div);
      });
    }

    document.getElementById("saveTemplateBtn").addEventListener("click", async () => {
      const name = document.getElementById("tplName").value.trim();
      const body = document.getElementById("tplBody").value.trim();
      const category = document.getElementById("tplCategory").value;

      if (!name || !body) {
        alert("Name and body are required.");
        return;
      }

      try {
        await apiPostJson("/api/templates", { name, body, category });
        showStatus("Template saved");
        document.getElementById("tplName").value = "";
        document.getElementById("tplBody").value = "";
        await loadTemplates();
      } catch (err) {
        console.error(err);
        showStatus("Failed to save template", "error");
      }
    });

    document.getElementById("resetTemplateBtn").addEventListener("click", () => {
      document.getElementById("tplName").value = "";
      document.getElementById("tplBody").value = "";
      document.getElementById("tplCategory").value = "utility";
      document
        .querySelectorAll(".template-item")
        .forEach(el => el.classList.remove("active"));
    });

    // -------------------- BROADCAST -------------------- //
    function populateBroadcastTemplateSelect() {
      const select = document.getElementById("broadcastTemplate");
      const previous = select.value;
      select.innerHTML = '<option value="">-- Select a template --</option>';

      templates.forEach(tpl => {
        const opt = document.createElement("option");
        const id = tpl.id || tpl._id || tpl.name;
        opt.value = id;
        opt.textContent = tpl.name;
        select.appendChild(opt);
      });

      if (previous) {
        select.value = previous;
      }
      updateBroadcastPreview();
    }

    function updateBroadcastPreview() {
      const select = document.getElementById("broadcastTemplate");
      const id = select.value;
      const previewEl = document.getElementById("broadcastPreview");

      const tpl = templates.find(
        t => (t.id || t._id || t.name) === id
      );
      previewEl.value = tpl ? tpl.body || "" : "";
    }

    document
      .getElementById("broadcastTemplate")
      .addEventListener("change", updateBroadcastPreview);

    // Manual broadcast
    document.getElementById("sendManualBtn").addEventListener("click", async () => {
      const tplId = document.getElementById("broadcastTemplate").value;
      if (!tplId) {
        alert("Select a template first.");
        return;
      }
      const raw = document.getElementById("manualNumbers").value.trim();
      if (!raw) {
        alert("Enter at least one number.");
        return;
      }
      const numbers = raw
        .split(/\r?\n/)
        .map(n => n.trim())
        .filter(Boolean);

      try {
        await apiPostJson("/api/broadcast/manual", {
          templateId: tplId,
          numbers
        });
        showStatus("Broadcast (manual) queued");
      } catch (err) {
        console.error(err);
        showStatus("Manual broadcast failed", "error");
      }
    });

    // File broadcast
    const excelInput = document.getElementById("excelFile");
    const fileNameEl = document.getElementById("fileName");

    excelInput.addEventListener("change", () => {
      const file = excelInput.files[0];
      fileNameEl.textContent = file ? file.name : "";
    });

    document.getElementById("sendFileBtn").addEventListener("click", async () => {
      const tplId = document.getElementById("broadcastTemplate").value;
      if (!tplId) {
        alert("Select a template first.");
        return;
      }
      const file = excelInput.files[0];
      if (!file) {
        alert("Choose an Excel file first.");
        return;
      }

      const fd = new FormData();
      fd.append("templateId", tplId);
      fd.append("file", file);

      try {
        const res = await fetch("/api/broadcast/upload", {
          method: "POST",
          body: fd
        });
        if (!res.ok) throw new Error("upload failed");
        showStatus("Broadcast (file) queued");
      } catch (err) {
        console.error(err);
        showStatus("File broadcast failed", "error");
      }
    });

    // -------------------- INITIAL LOAD -------------------- //
    (async function init() {
      await loadContacts();
      await loadTemplates();
    })();
  </script>
</body>
</html>
