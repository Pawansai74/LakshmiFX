<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WhatsApp Inbox – LakshmiFX</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background: #0b1020; color: #f5f5f5; }
    #wrap { display: flex; height: 100vh; }
    #contacts { width: 28%; border-right: 1px solid #222; overflow-y: auto; background: #101628; }
    #chat { flex: 1; display: flex; flex-direction: column; background: #060814; }

    .header { padding: 10px 14px; font-weight: bold; border-bottom: 1px solid #222; background: #11182b; }

    .contact { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #1a2238; }
    .contact:hover { background: #18233a; }
    .contact.active { background: #243353; }
    .contact .num { font-size: 14px; font-weight: 600; }
    .contact .time { font-size: 11px; color: #9ca3af; margin-top: 2px; }

    #messages { flex: 1; padding: 14px; overflow-y: auto; display: flex; flex-direction: column; }
    .msg { margin: 4px 0; max-width: 70%; padding: 8px 10px; border-radius: 10px; font-size: 14px; line-height: 1.3; }
    .in { background: #1f2933; align-self: flex-start; }
    .out { background: #2563eb; align-self: flex-end; }

    #composer { display: flex; padding: 10px; border-top: 1px solid #222; background: #0d1324; }
    #composer input { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #374151; background: #020617; color: #f9fafb; }
    #composer button { margin-left: 8px; padding: 8px 16px; border: none; border-radius: 6px; background: #10b981; color: #000; font-weight: 600; cursor: pointer; }
    #composer button:hover { background: #22c55e; }

    .empty { padding: 20px; color: #9ca3af; font-size: 14px; }
  </style>
</head>
<body>
<div id="wrap">
  <div id="contacts">
    <div class="header">Contacts</div>
    <div id="contactList"></div>
  </div>

  <div id="chat">
    <div class="header" id="chatHeader">Chat</div>
    <div id="messages">
      <div class="empty">Select a contact from the left panel.</div>
    </div>
    <div id="composer">
      <input id="text" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script>
  let selectedContact = null;

  async function loadContacts() {
    try {
      const res = await fetch("/api/contacts");
      const contacts = await res.json();
      const list = document.getElementById("contactList");
      list.innerHTML = "";

      if (!contacts.length) {
        list.innerHTML = '<div class="empty">No contacts yet. Send a WhatsApp message to your number to start.</div>';
        return;
      }

      contacts.forEach(c => {
        const div = document.createElement("div");
        div.className = "contact";
        div.dataset.number = c.waNumber;

        const num = document.createElement("div");
        num.className = "num";
        num.textContent = c.waNumber;

        const time = document.createElement("div");
        time.className = "time";
        time.textContent = c.lastMessageAt
          ? ("Last: " + new Date(c.lastMessageAt).toLocaleString())
          : "No messages";

        div.appendChild(num);
        div.appendChild(time);

        div.onclick = () => selectContact(c);
        list.appendChild(div);
      });
    } catch (e) {
      console.error("Error loading contacts", e);
    }
  }

  async function selectContact(c) {
    selectedContact = c;

    document.querySelectorAll(".contact").forEach(el => {
      el.classList.toggle("active", el.dataset.number === c.waNumber);
    });

    document.getElementById("chatHeader").textContent = "Chat – " + c.waNumber;

    const res = await fetch("/api/messages?waNumber=" + encodeURIComponent(c.waNumber));
    const msgs = await res.json();

    const box = document.getElementById("messages");
    box.innerHTML = "";

    if (!msgs.length) {
      box.innerHTML = '<div class="empty">No messages yet.</div>';
      return;
    }

    msgs.forEach(m => {
      const div = document.createElement("div");
      div.className = "msg " + m.direction;
      div.textContent = m.text || "[no text]";
      box.appendChild(div);
    });

    box.scrollTop = box.scrollHeight;
  }

  async function sendMessage() {
    if (!selectedContact) {
      alert("Select a contact first.");
      return;
    }
    const input = document.getElementById("text");
    const text = input.value.trim();
    if (!text) return;

    try {
      const res = await fetch("/api/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ waNumber: selectedContact.waNumber, text })
      });

      const data = await res.json();
      if (!data.ok) {
        console.error("Send failed", data);
        alert("Send failed – check server logs.");
        return;
      }

      input.value = "";
      await selectContact(selectedContact); // refresh chat
    } catch (e) {
      console.error("Error sending", e);
    }
  }

  document.getElementById("sendBtn").onclick = sendMessage;
  document.getElementById("text").addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
  });

  // initial load + polling
  loadContacts();
  setInterval(loadContacts, 15000); // refresh contact list every 15 sec
</script>
</body>
</html>
